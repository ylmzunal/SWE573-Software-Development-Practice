{% load static %}

<div>
    <h2>{{ post.title }}</h2>
    <p>{{ post.content }}</p>
    <h2>Properties</h2>
    <ul>
        <li><strong>Material:</strong> {{ post.material }}</li>
        <li><strong>Size (cm):</strong> {{ post.size }}</li>
        <li><strong>Color:</strong> {{ post.color }}</li>
        <li><strong>Shape:</strong> {{ post.shape }}</li>
        <li><strong>Weight (kg):</strong> {{ post.weight }}</li>
    </ul>
    
    <!-- Birleştirilmiş özellikler formu -->
    <form action="{% url 'search_results' %}" method="GET">
        <input type="hidden" name="q" value="
            {% if post.material %}{{ post.material }} {% endif %}
            {% if post.size %}{{ post.size }}cm {% endif %}
            {% if post.color %}{{ post.color }} {% endif %}
            {% if post.shape %}{{ post.shape }} {% endif %}
            {% if post.weight %}{{ post.weight }}kg{% endif %}
        ">
        <button type="submit">Search Wikidata</button>
    </form>

    {% comment %} {% if post.image %}
    <img src="{{ post.image.url }}" alt="Post Image" class="post-image">
    {% endif %} {% endcomment %}
    <div class="post-image-container" style="text-align: center;">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.title }}" style="width: 100%; max-width: 800px; height: auto;">
        {% endif %}
    </div>
    <!-- Vote Buttons for Post -->
    <div class="post-votes">
        <!-- Wiki Search Butonu -->
        <form action="{% url 'search_results' %}" method="get">
            <input type="hidden" name="q" value="{% for tag in post.tags.all %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %}">
            <button type="submit">Wiki Search</button>
        </form>
        <small>
            Author: {{ post.user.username }}
        </small>
        <small> | Answers: {{ post.comments.count }}</small>
        <small> | {{ post.created_at }} | </small>
        <button onclick="vote('post', {{ post.id }}, 'upvote')">
            &#x25B2; <!-- Up arrow -->
        </button>
        <span id="post-upvotes-{{ post.id }}">{{ post.upvotes }}</span>
        <button onclick="vote('post', {{ post.id }}, 'downvote')">
            &#x25BC; <!-- Down arrow -->
        </button>
        <span id="post-downvotes-{{ post.id }}">{{ post.downvotes }}</span>
    </div>

    <!-- Yorumları Görüntüleme -->
    <div id="comments-section">
        <h3>Answers</h3>
        {% for comment in comments %}
            <div class="comment">
                <p>{{ comment.content }}</p>
                <small>
                    Author: {% if comment.user %} {{ comment.user.username }} {% else %} Anonymous {% endif %}
                    | {{ comment.created_at }}
                </small>
            </div>
        {% empty %}
            <p>No answers yet. Be the first to answer!</p>
        {% endfor %}
    </div>


    <!-- Vote Buttons for Comment -->
    <div class="comment-votes">
        <button onclick="vote('comment', {{ comment.id }}, 'upvote')">
            &#x25B2; <!-- Up arrow -->
        </button>
        <span id="comment-upvotes-{{ comment.id }}">{{ comment.upvotes }}</span>
        <button onclick="vote('comment', {{ comment.id }}, 'downvote')">
            &#x25BC; <!-- Down arrow -->
        </button>
        <span id="comment-downvotes-{{ comment.id }}">{{ comment.downvotes }}</span>
    </div>

    <!-- Yorum Ekleme Formu -->
    <form method="POST" action="{% url 'add_comment' post.id %}">
        {% csrf_token %}
        <textarea name="content" placeholder="Add your comment here..." required></textarea>
        <button type="submit">Submit</button>
    </form>
</div>

<script>
    function vote(type, id, voteType) {
        const url = `/vote/${type}/${id}/${voteType}/`;
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (type === 'post') {
                document.getElementById(`post-upvotes-${id}`).textContent = data.upvotes;
                document.getElementById(`post-downvotes-${id}`).textContent = data.downvotes;
            } else if (type === 'comment') {
                document.getElementById(`comment-upvotes-${id}`).textContent = data.upvotes;
                document.getElementById(`comment-downvotes-${id}`).textContent = data.downvotes;
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>


{% comment %} Dinamik Ekran  {% endcomment %}
{% comment %} <div id="post-details">
    <h1>{{ post.title }}</h1>
    <p>{{ post.content }}</p>

    {% if post.image %}
        <img src="{{ post.image.url }}" alt="Post Image">
    {% endif %}

    <hr>

    <h2>Comments</h2>
    <div id="comments-list">
        {% for comment in comments %}
    <div class="comment">
        <p>{{ comment.content }}</p>
        <small>
            By 
            {% if comment.user %}
                {{ comment.user.username }}
            {% else %}
                Anonymous
            {% endif %}
            | {{ comment.created_at }}
        </small>
    </div>
{% endfor %}
    </div>

    <hr>

    <h3>Add a Comment</h3>
    <form id="comment-form">
        {% csrf_token %}
        <textarea name="content" id="comment-content" rows="4" placeholder="Write your comment"></textarea>
        <button type="submit">Submit Comment</button>
    </form>
</div> {% endcomment %}

{% comment %} <script>
    const form = document.getElementById('comment-form');
    const commentsList = document.getElementById('comments-list');

    form.addEventListener('submit', function (e) {
        e.preventDefault();

        const content = document.getElementById('comment-content').value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch("{% url 'add_comment' post.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const newComment = document.createElement('div');
                newComment.classList.add('comment');
                newComment.innerHTML = `
                    <p>${data.comment.content}</p>
                    <small>By ${data.comment.username} | ${data.comment.created_at}</small>
                `;
                commentsList.appendChild(newComment);
                form.reset();  // Formu temizle
            } else {
                alert('Failed to add comment');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
</script>  {% endcomment %}
