{% load static %}

<div id="post-details">
    <h2>{{ post.title }}</h2>
    <p>{{ post.content }}</p>
    <h2>Properties</h2>
    <ul>
        <li><strong>Material:</strong> {{ post.material }}</li>
        <li><strong>Size (cm):</strong> {{ post.size }}</li>
        <li><strong>Color:</strong> {{ post.color }}</li>
        <li><strong>Shape:</strong> {{ post.shape }}</li>
        <li><strong>Weight (gr):</strong> {{ post.weight }}</li>
    </ul>

    <form action="{% url 'search_results' %}" method="GET">
        <input type="hidden" name="q" value="
            {% if post.material %}{{ post.material }} {% endif %}
            {% if post.size %}{{ post.size }}cm {% endif %}
            {% if post.color %}{{ post.color }} {% endif %}
            {% if post.shape %}{{ post.shape }} {% endif %}
            {% if post.weight %}{{ post.weight }}kg{% endif %}
        ">
        <button type="submit">Search Wikidata</button>
    </form>
    {% comment %} <div style="margin-top: 20px;">
        <form action="{% url 'analyze_post' post.id %}" method="GET">
            <button type="submit">Analyze Post</button>
        </form>
    </div> {% endcomment %}
        <!-- NLP ile Çıkarılan Anahtar Kelimeler -->
        {% comment %} <h3>Extracted Keywords:</h3>
        <ul>
            {% for keyword in keywords %}
                <li>{{ keyword }}</li>
            {% endfor %}
        </ul> {% endcomment %}
    
        <!-- Anahtar Kelimelerle Wikidata Arama Butonu -->
        {% comment %} <form action="{% url 'search_results' %}" method="GET" class="wikidata-search-form">
            <input type="hidden" name="q" value="{% for keyword in keywords %}{{ keyword }} {% endfor %}">
            <button type="submit" class="btn btn-primary">Search Wikidata</button>
        </form> {% endcomment %}

    <div class="post-image-container" style="text-align: center;">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.title }}" style="width: 100%; max-width: 800px; height: auto;">
        {% endif %}
    </div>
    <small>
        Author: {{ post.author.username }}
    </small>
    <small> | {{ post.created_at }} | </small>
    <small> {% if user.is_authenticated %} | 
        Answers: {{ post.comments.count }}
        {% endif %} </small>

        {% if can_mark_as_solved %}
        <form method="POST" action="{% url 'mark_as_solved' post.id %}">
            {% csrf_token %}
            <button type="submit">Mark as Solved</button>
        </form>
    {% elif post.solved %}
        <p><strong>This post has been marked as solved.</strong></p>
    {% endif %}

   {% comment %} <div class="post-votes">
        <button onclick="vote('post', {{ post.id }}, 'upvote')">
            &#x25B2;
        </button>
        <span id="post-upvotes-{{ post.id }}">{{ post.upvotes }}</span>
        <button onclick="vote('post', {{ post.id }}, 'downvote')">
            &#x25BC;
        </button>
        <span id="post-downvotes-{{ post.id }}">{{ post.downvotes }}</span>
    </div> {% endcomment %}

    <div id="comments-section">
        <h3>Answers</h3>
        {% for comment in comments %}
            <div class="comment">
                <p>{{ comment.content }}</p>
                <small>
                    Author: {% if comment.user %} {{ comment.user.username }} {% else %} Anonymous {% endif %}
                    | {{ comment.created_at }}
                </small>
                <!-- Oy verme butonları -->
                <div class="comment-votes">
                    <button class="vote-btn" onclick="voteComment({{ comment.id }}, 'upvote')">
                        &#x25B2; <!-- Yukarı ok -->
                    </button>
                    <span id="comment-upvotes-{{ comment.id }}">{{ comment.upvotes }}</span>
                    <button class="vote-btn" onclick="voteComment({{ comment.id }}, 'downvote')">
                        &#x25BC; <!-- Aşağı ok -->
                    </button>
                    <span id="comment-downvotes-{{ comment.id }}">{{ comment.downvotes }}</span>
                </div>
            </div>
        {% empty %}
            <p>No answers yet. Be the first to answer!</p>
        {% endfor %}
    </div>

    {% if not post.solved %}
    <form id="comment-form" method="POST" action="{% url 'add_comment' post.id %}">
        {% csrf_token %}
        <textarea name="content" placeholder="Add your comment here..." required></textarea>
        <button type="submit">Submit</button>
    </form>
    {% endif %}
</div>

<script>
    document.getElementById('comment-form').addEventListener('submit', function (event) {
        event.preventDefault();
    
        const formData = new FormData(this);
    
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const commentsSection = document.getElementById('comments');
                commentsSection.insertAdjacentHTML('beforeend', `
                    <div class="comment">
                        <p>${data.comment.content}</p>
                        <small>By ${data.comment.author} | ${data.comment.created_at}</small>
                    </div>
                `);
                this.reset();  // Formu sıfırla
            } else {
                alert('Error adding comment.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
</script>

<script>
    function voteComment(commentId, voteType) {
        fetch('/vote-comment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({ comment_id: commentId, vote_type: voteType }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Güncellenen oylama sayısını UI'ye yansıt
                document.getElementById(`comment-upvotes-${commentId}`).textContent = data.upvotes;
                document.getElementById(`comment-downvotes-${commentId}`).textContent = data.downvotes;
            } else {
                alert('Oylama sırasında bir hata oluştu: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Beklenmeyen bir hata oluştu.');
        });
    }
</script>
 
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const markSolvedBtn = document.getElementById('mark-solved-btn');
        const markSolvedSection = document.getElementById('mark-solved-section');
        const commentFormContainer = document.getElementById('comment-form-container');
    
        if (markSolvedBtn) {
            markSolvedBtn.addEventListener('click', function () {
                const postId = markSolvedBtn.dataset.postId;
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
                fetch(`/post/${postId}/mark-as-solved/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.solved) {
                            // UI Güncelle
                            markSolvedSection.innerHTML = '<p><strong>This post has been marked as solved.</strong></p>';
                            if (commentFormContainer) {
                                commentFormContainer.innerHTML = ''; // Yorum formunu kaldır
                            }
                        } else {
                            alert('Failed to mark as solved: ' + (data.error || 'Unknown error.'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An unexpected error occurred.');
                    });
            });
        }
    });
</script>

