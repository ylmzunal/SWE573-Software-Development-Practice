{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Finder</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <header>
        <div class="nav">
            {% if user.is_authenticated %}
            <button id="create-post-btn" class="action-btn">Create New Post</button>
        {% endif %}
            {% if user.is_authenticated %}
                <form method="post" action="{% url 'logout' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="nav-btn">Logout</button>
                </form>
                <a href="{% url 'profile' user.username %}" class="nav-link">{{ user.username }}</a>
            {% else %}
                <a href="{% url 'login' %}" class="nav-link">Login</a>
                <a href="{% url 'register' %}" class="nav-link">Register</a>
            {% endif %}
        </div>
        <!-- Wikidata Search Bar -->
        <form method="get" action="{% url 'wikidata_search' %}">
            <input type="text" name="q" placeholder="Search Wikidata">
            <button type="submit">Search</button>
        </form>
        <div class="brand">
            <h1>Object Finder</h1>
        </div>
    </header>

    <main class="container">
        <aside class="sidebar">
            <h2>Questions</h2>
            <div id="post-list">
                {% for post in posts %}
                    <div class="post" onclick="loadPostDetails({{ post.id }})">
                        <h3>{{ post.title }}</h3>
                        <p>{{ post.content|truncatechars:100 }}</p>
                        {% if post.image %}
                            <img src="{{ post.image.url }}" alt="Post Image" class="post-image">
                        {% endif %}
                        <div class="post-meta">
                            <small>
                                Author: {% if post.author %} {{ post.author.username }} {% else %} Anonymous {% endif %}
                            </small>
                            <small> | {{ post.created_at }} | </small>
                            <small> | Answers: {{ post.comments.count }}</small>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </aside>

        <section class="main-content" id="main-content">
            <h2>Question Details</h2>
            <p>Select a post to see its details and comments.</p>
        </section>
    </main>

    {% if user.is_authenticated %}
        <button id="create-post-btn" class="action-btn" >Create New Post</button>
    {% endif %}

    <script>
        document.getElementById('create-post-btn').addEventListener('click', function () {
            fetch('/create-post-form/')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('main-content').innerHTML = html;
        
                    // Formu dinle
                    const postForm = document.getElementById('post-form');
                    postForm.addEventListener('submit', async function (event) {
                        event.preventDefault();
        
                        const formData = new FormData(postForm);
                        const response = await fetch('/create-post/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            },
                            body: formData,
                        });
        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                // Yeni postu sol listeye ekle
                                const postList = document.getElementById('post-list');
                                const newPostHTML = `
                                    <div class="post" id="post-${data.post.id}">
                                        <h3>${data.post.title}</h3>
                                        <p>${data.post.content}</p>
                                        ${data.post.image_url ? `<img src="${data.post.image_url}" alt="Post Image" style="width: 100%; max-width: 800px; height: auto;">` : ''}
                                        <small>By ${data.post.author}</small>
                                    </div>
                                `;
                                postList.insertAdjacentHTML('afterbegin', newPostHTML);
        
                                // Yeni post'a tıklama olayını bağla
                                const newPostElement = document.getElementById(`post-${data.post.id}`);
                                newPostElement.addEventListener('click', function () {
                                    loadPostDetails(data.post.id);
                                });
        
                                // Yeni post'a tıklama simüle et
                                newPostElement.click();
                            } else {
                                alert('Error: ' + JSON.stringify(data.errors));
                            }
                        } else {
                            alert('Unexpected error occurred.');
                        }
                    });
                });
        });
        
        // Post detaylarını yükleme fonksiyonu
        function loadPostDetails(postId) {
            fetch(`/post-details/${postId}/`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('main-content').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading post details:', error);
                    alert('Unable to load post details.');
                });
        }
    </script>
    

</body>
</html>